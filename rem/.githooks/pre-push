#!/bin/bash
#
# Pre-push hook for remstack/rem
#
# Runs integration tests before push, skipping LLM tests (expensive and require API keys)
#

set -e

echo "=== Pre-push: Running integration tests ==="

echo ""
echo ">>> Starting test database..."
docker compose -f docker-compose.test.yml up -d

echo ">>> Waiting for database to be ready..."
for i in {1..30}; do
    if docker exec rem-postgres-test pg_isready -U rem > /dev/null 2>&1; then
        echo "Database ready"
        break
    fi
    sleep 1
done

echo ""
echo ">>> Running integration tests (DB-only, skipping LLM tests)..."
# Skip LLM-marked tests which require real API calls and have async isolation issues
POSTGRES__CONNECTION_STRING="postgresql://rem:rem@localhost:5433/rem" \
    uv run pytest tests/integration/ -v -m "not llm" || {
        echo ""
        echo ">>> Stopping test database..."
        docker compose -f docker-compose.test.yml down -v
        exit 1
    }

echo ""
echo ">>> Stopping test database..."
docker compose -f docker-compose.test.yml down -v

echo ""
echo "âœ“ Integration tests passed"
echo ""
echo "=== Pre-push: OK ==="

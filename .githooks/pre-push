#!/bin/bash
# Pre-push Hook: Run Integration Tests in Docker
# Skip with: git push --no-verify
# Install: git config core.hooksPath .githooks

set -e

echo "=== Pre-push: Running integration tests ==="

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT/rem"

# Start test database
echo ""
echo ">>> Starting test database..."
docker compose -f docker-compose.test.yml up -d

# Wait for database to be ready
echo ">>> Waiting for database to be ready..."
for i in {1..30}; do
    if docker compose -f docker-compose.test.yml exec -T postgres pg_isready -U rem -d rem > /dev/null 2>&1; then
        echo "Database ready"
        break
    fi
    if [ $i -eq 30 ]; then
        echo "Database failed to start"
        docker compose -f docker-compose.test.yml down -v
        exit 1
    fi
    sleep 1
done

# Run integration tests (DB-only, exclude LLM tests)
echo ""
echo ">>> Running integration tests (DB-only)..."

export POSTGRES__CONNECTION_STRING="postgresql://rem:rem@localhost:5051/rem"

TEST_RESULT=0
uv run pytest tests/integration \
    --ignore=tests/integration/test_natural_language_to_rem.py \
    --ignore=tests/integration/test_agent_end_to_end.py \
    --ignore=tests/integration/test_agent_tool_invocation.py \
    --ignore=tests/integration/test_agent_with_tools.py \
    --ignore=tests/integration/test_completions_with_sessions.py \
    --ignore=tests/integration/test_rem_query_agent.py \
    --ignore=tests/integration/test_rem_query_agent_structured.py \
    --ignore=tests/integration/test_rem_query_evolution.py \
    --ignore=tests/integration/test_contract_extractor.py \
    --ignore=tests/integration/test_dreaming_moments.py \
    --ignore=tests/integration/test_schema_introspection.py \
    -q --tb=short || TEST_RESULT=$?

# Cleanup
echo ""
echo ">>> Cleaning up test database..."
docker compose -f docker-compose.test.yml down -v

if [ $TEST_RESULT -ne 0 ]; then
    echo ""
    echo "Integration tests failed"
    exit 1
fi

echo ""
echo "=== Pre-push: OK ==="

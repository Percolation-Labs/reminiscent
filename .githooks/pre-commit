#!/bin/bash
# =============================================================================
# Pre-commit Hook: Run Unit Tests
# =============================================================================
# Runs unit tests before allowing commits. Fails fast on any test failure.
#
# Install: git config core.hooksPath .githooks
# =============================================================================

set -e

echo "=== Pre-commit: Running unit tests ==="

# Get the repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if rem package has changes
REM_CHANGED=$(git diff --cached --name-only -- 'rem/' | wc -l | tr -d ' ')

# Run tests if rem changed
if [ "$REM_CHANGED" -gt 0 ]; then
    echo ""
    echo ">>> REM package changes detected - running pytest..."
    cd "$REPO_ROOT/rem"

    # Sync dependencies if needed
    if [ ! -d ".venv" ]; then
        echo "Installing dependencies..."
        uv sync --frozen --quiet
    fi

    # Run unit tests only (fast, no DB required)
    uv run pytest tests/unit -q --tb=short
    echo "âœ“ Unit tests passed"
else
    echo "No REM package changes - skipping unit tests"
fi

echo ""
echo "=== Pre-commit: OK ==="

#!/bin/bash
# =============================================================================
# Pre-commit Hook: Run Unit Tests
# =============================================================================
# Runs unit tests before allowing commits. Fails fast on any test failure.
# Unit tests are isolated (no database required).
#
# Install: git config core.hooksPath .githooks
# Skip: git commit --no-verify
# =============================================================================

set -e

echo "=== Pre-commit: Running unit tests ==="

# Get the repo root and rem directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
REM_DIR="$REPO_ROOT/rem"
cd "$REM_DIR"

# Check if source files changed (relative to rem/)
SRC_CHANGED=$(git diff --cached --name-only -- 'rem/src/' 'rem/tests/' | wc -l | tr -d ' ')

if [ "$SRC_CHANGED" -gt 0 ]; then
    echo ""
    echo ">>> Source changes detected - running unit tests..."

    # Sync dependencies if needed
    if [ ! -d ".venv" ]; then
        echo "Installing dependencies..."
        uv sync --frozen --quiet
    fi

    # Run unit tests (no DB required)
    uv run pytest tests/unit/ -q --tb=line -m "not llm" 2>/dev/null
    echo "âœ“ Unit tests passed"
else
    echo "No source changes - skipping unit tests"
fi

echo ""
echo "=== Pre-commit: OK ==="

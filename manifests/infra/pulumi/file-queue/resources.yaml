# S3 â†’ SQS event queue for file processing
#
# Architecture:
# - S3 bucket "rem" with notifications on uploads/
# - SQS queue receives S3 ObjectCreated events
# - IRSA-enabled K8s pods consume queue with Python
#
# Event flow:
# 1. File uploaded to s3://rem/uploads/*
# 2. S3 sends event to SQS queue
# 3. Python consumer polls queue (long polling)
# 4. Processes file, deletes message from queue

variables:
  bucketName: rem
  queueName: rem-file-processing
  uploadPrefix: uploads/

resources:
  # S3 Bucket for file uploads
  remBucket:
    type: aws:s3:BucketV2
    properties:
      bucket: ${bucketName}
      tags:
        Purpose: file-uploads
        Component: rem-storage

  # Enable versioning for file recovery
  bucketVersioning:
    type: aws:s3:BucketVersioningV2
    properties:
      bucket: ${remBucket.id}
      versioningConfiguration:
        status: Enabled

  # Block public access
  bucketPublicAccessBlock:
    type: aws:s3:BucketPublicAccessBlock
    properties:
      bucket: ${remBucket.id}
      blockPublicAcls: true
      blockPublicPolicy: true
      ignorePublicAcls: true
      restrictPublicBuckets: true

  # SQS Queue for file processing events
  fileProcessingQueue:
    type: aws:sqs:Queue
    properties:
      name: ${queueName}
      visibilityTimeoutSeconds: 300      # 5 min - adjust based on processing time
      messageRetentionSeconds: 86400     # 24 hours
      receiveWaitTimeSeconds: 20         # Long polling (reduces empty receives)
      tags:
        Purpose: file-event-processing
        Component: rem-queue

  # Dead Letter Queue for failed processing
  fileProcessingDLQ:
    type: aws:sqs:Queue
    properties:
      name: ${queueName}-dlq
      messageRetentionSeconds: 1209600   # 14 days
      tags:
        Purpose: failed-file-processing
        Component: rem-queue-dlq

  # Configure DLQ redrive policy
  queueRedrivePolicy:
    type: aws:sqs:QueueRedrivePolicy
    properties:
      queueUrl: ${fileProcessingQueue.url}
      redrivePolicy:
        fn::toJSON:
          deadLetterTargetArn: ${fileProcessingDLQ.arn}
          maxReceiveCount: 3

  # SQS Queue Policy - Allow S3 to send messages
  queuePolicy:
    type: aws:sqs:QueuePolicy
    properties:
      queueUrl: ${fileProcessingQueue.url}
      policy:
        fn::toJSON:
          Version: "2012-10-17"
          Statement:
            - Sid: AllowS3ToSendMessage
              Effect: Allow
              Principal:
                Service: s3.amazonaws.com
              Action: sqs:SendMessage
              Resource: ${fileProcessingQueue.arn}
              Condition:
                ArnLike:
                  aws:SourceArn: ${remBucket.arn}

  # S3 Bucket Notification - Send events to SQS
  bucketNotification:
    type: aws:s3:BucketNotification
    properties:
      bucket: ${remBucket.id}
      queues:
        - queueArn: ${fileProcessingQueue.arn}
          events:
            - "s3:ObjectCreated:*"
          filterPrefix: ${uploadPrefix}
    options:
      dependsOn:
        - ${queuePolicy}

  # IAM Policy for queue + bucket access (used by K8s pods via IRSA)
  fileProcessorPolicy:
    type: aws:iam:Policy
    properties:
      name: rem-file-processor-policy
      description: Allows consuming SQS queue and reading S3 objects
      policy:
        fn::toJSON:
          Version: "2012-10-17"
          Statement:
            - Sid: AllowSQSConsume
              Effect: Allow
              Action:
                - sqs:ReceiveMessage
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
                - sqs:ChangeMessageVisibility
              Resource: ${fileProcessingQueue.arn}
            - Sid: AllowS3Read
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:GetObjectVersion
                - s3:GetObjectAttributes
              Resource: ${remBucket.arn}/*
            - Sid: AllowDLQRead
              Effect: Allow
              Action:
                - sqs:ReceiveMessage
                - sqs:GetQueueAttributes
              Resource: ${fileProcessingDLQ.arn}
      tags:
        Purpose: file-processor-permissions
        Component: rem-iam

outputs:
  queueUrl:
    value: ${fileProcessingQueue.url}
  queueArn:
    value: ${fileProcessingQueue.arn}
  dlqUrl:
    value: ${fileProcessingDLQ.url}
  bucketName:
    value: ${remBucket.bucket}
  bucketArn:
    value: ${remBucket.arn}
  policyArn:
    value: ${fileProcessorPolicy.arn}

# REM Application Manifests

This directory contains Kubernetes manifests for the REM stack, organized using **Kustomize** for multi-environment deployment with semantic versioning.

## Architecture

The REM stack consists of **2 deployments** in the `rem` namespace:

1. **rem-api**: FastAPI server with **MCP server mounted** (not separate)
2. **file-processor**: KEDA-scaled worker for file processing

**Important**: The MCP (Model Context Protocol) server is **not a separate deployment**. It is mounted as part of the rem-api FastAPI application.

## Namespace Structure

The application uses **3 namespaces** (configurable via `APP_NAMESPACE` in CDK):

- **rem** (default): All application components (api + worker)
- **observability**: OpenTelemetry collector
- **postgres-cluster**: PostgreSQL cluster (CloudNativePG)

Namespace is configurable via CDK's `.env` file (`APP_NAMESPACE` defaults to cluster name prefix).

## Directory Structure

```
application/
└── rem-stack/                 # Kustomize-based deployment
    ├── components/            # Individual components
    │   ├── api/              # REM API (FastAPI with MCP mounted)
    │   │   ├── deployment.yaml
    │   │   ├── service.yaml
    │   │   ├── ingress.yaml
    │   │   ├── hpa.yaml
    │   │   ├── pdb.yaml
    │   │   ├── serviceaccount.yaml
    │   │   ├── secretstore.yaml       # Shared SecretStore
    │   │   ├── external-secret.yaml   # LLM API keys
    │   │   ├── configmap.yaml
    │   │   └── kustomization.yaml
    │   ├── worker/           # File processor (KEDA-scaled)
    │   │   ├── deployment.yaml
    │   │   ├── keda-scaledobject.yaml
    │   │   ├── serviceaccount.yaml
    │   │   └── kustomization.yaml
    │   └── postgres/         # PostgreSQL cluster (deploy separately)
    │       ├── postgres-cluster.yaml
    │       ├── postgres-init-configmap.yaml  # Generated from SQL
    │       └── kustomization.yaml
    ├── base/                  # Base configuration (references components)
    │   └── kustomization.yaml # Namespace: rem-app, ConfigMapGenerator
    ├── overlays/              # Environment-specific configuration
    │   ├── staging/          # Staging environment (v1.2.3-rc.1)
    │   │   └── kustomization.yaml
    │   └── prod/             # Production environment (v1.2.3)
    │       └── kustomization.yaml
    ├── argocd-staging.yaml   # ArgoCD Application for staging
    ├── argocd-prod.yaml      # ArgoCD Application for production
    └── README.md             # Detailed KEDA + ArgoCD documentation
```

## Configuration

The REM application is configured via:
1. **External Secrets**: API keys pulled from SSM Parameter Store (created by CDK)
2. **ConfigMaps**: Generated by Kustomize overlays or ArgoCD

### Secrets from SSM

External Secrets Operator pulls secrets from AWS SSM Parameter Store:

| Secret | SSM Parameter |
|--------|---------------|
| `rem-llm-secrets` | `/rem/llm/anthropic-api-key`, `/rem/llm/openai-api-key` |
| `rem-postgres-secret` | `/rem/postgres/username`, `/rem/postgres/password` |
| `rem-phoenix-secrets` | `/rem/phoenix/api-key`, `/rem/phoenix/secret`, `/rem/phoenix/admin-secret` |

These SSM parameters are created by CDK when `ENABLE_SSM_PARAMETERS=true`.

### KEDA ScaledObject

The file-processor uses KEDA for SQS-based autoscaling. The queue URL is configured in the ScaledObject manifest and should match your CDK deployment.

## Quick Start

### Deploy to Staging

```bash
# Set environment variables
export ECR_REGISTRY="123456789012.dkr.ecr.us-east-1.amazonaws.com"
export IMAGE_TAG="v1.2.3-rc.1"

# Deploy
kubectl apply -k manifests/application/rem-stack/overlays/staging
```

### Deploy to Production

```bash
export ECR_REGISTRY="123456789012.dkr.ecr.us-east-1.amazonaws.com"
export IMAGE_TAG="v1.2.3"

kubectl apply -k manifests/application/rem-stack/overlays/prod
```

### Deploy with ArgoCD (GitOps)

```bash
# 1. Fork this repository
# 2. Update argocd-*.yaml with your fork URL
# 3. Apply ArgoCD Applications
kubectl apply -f manifests/application/rem-stack/argocd-staging.yaml
kubectl apply -f manifests/application/rem-stack/argocd-prod.yaml
```

## Components

### rem-api (Deployment)
- **FastAPI server** with REST and streaming endpoints
- **MCP server mounted** at `/api/v1/mcp` (not separate)
- Horizontal Pod Autoscaler (HPA) for CPU-based scaling
- Pod Disruption Budget (PDB) for high availability
- External Secrets for LLM API keys (Anthropic, OpenAI)
- Ingress for external access

### file-processor (Deployment)
- **KEDA-scaled worker** for file processing
- Scales **0-20 replicas** based on SQS queue depth
- Spot instances preferred (cost optimization)
- Pod anti-affinity for distribution
- Same SecretStore as API (shared AWS resources)

### PostgreSQL (Separate)
- **CloudNativePG cluster** (deployed independently)
- Init scripts via ConfigMap (generated from `rem/sql/migrations/*.sql`)
- pgvector extension for semantic search
- Deployed to `postgres` namespace

## PostgreSQL Separate Deployment

PostgreSQL can be deployed independently:

```bash
# Deploy postgres only
kubectl apply -k manifests/application/rem-stack/components/postgres

# Or include in main stack by uncommenting in base/kustomization.yaml:
# resources:
#   - ../components/postgres
```

### SQL Init Scripts

PostgreSQL initialization scripts are included when generating cluster manifests:

```bash
# Generate all manifests (includes SQL ConfigMap)
rem cluster generate

# The command generates:
# - ArgoCD Application manifests
# - ClusterSecretStore configurations
# - SQL init ConfigMap (from rem/sql/migrations/*.sql)
```

## Features

- **Semantic Versioning**: Tag images with semver (v1.2.3, v1.2.3-rc.1)
- **KEDA Autoscaling**: Worker scales 0-20 based on SQS queue depth
- **ArgoCD Integration**: GitOps with automatic sync
- **Environment Overlays**: Staging vs Production configurations
- **Component-Based**: Deploy individual services or full stack

## Documentation

For detailed documentation, see:
- [rem-stack/README.md](rem-stack/README.md) - Complete deployment guide
- [rem-stack/components/postgres/](rem-stack/components/postgres/) - PostgreSQL setup

## Migration from Old Structure

**Old structure (removed):**
```
application/
├── rem-api/        # Individual manifests
├── rem-mcp/        # Individual manifests
└── file-processor/ # Individual manifests
```

**New structure (current):**
```
application/
└── rem-stack/      # Kustomize-only approach
    └── components/ # Organized by component
```

All manifests have been moved to `rem-stack/components/` for a cleaner, Kustomize-native structure.

# Kustomize Overlay: Local Development
#
# This overlay patches production manifests for local Kubernetes (kind/minikube):
# - Removes CRD dependencies (ExternalSecrets, CloudNativePG, KEDA, HPA)
# - Uses standalone PostgreSQL deployment
# - Uses static secrets instead of ExternalSecrets
# - Disables auth, OTEL, and other production features
#
# IMPORTANT: Production manifests are the source of truth.
# This overlay only PATCHES - never duplicate resources that exist in base/components.
#
# Usage:
#   kubectl apply -k manifests/application/rem-stack/overlays/local
#   OR via Tilt:
#   tilt up -- --k8s_mode
#
# Prerequisites:
#   - kind or minikube cluster running
#   - No CRDs required (standalone postgres, static secrets)

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Override namespace for local development
namespace: rem-local

# Reference production API component (includes all resources)
# We then DELETE the CRD-dependent resources via patches below
resources:
  # Production API component
  - ../../components/api
  # Local-specific resources (no CRD dependencies)
  - postgres.yaml
  - secrets.yaml
  - namespace.yaml

# Environment labels
commonLabels:
  environment: local
  app.kubernetes.io/managed-by: tilt

# Override image to use local build
images:
  - name: percolationlabs/rem
    newName: rem-local
    newTag: latest

# ConfigMap for local environment (replace production values)
configMapGenerator:
  - name: rem-config
    behavior: create
    literals:
      - ENVIRONMENT=local
      - OTEL__ENABLED=false
      - LOG_LEVEL=debug

  - name: rem-api-config
    behavior: replace
    literals:
      - AWS_REGION=us-east-1
      - OTEL_COLLECTOR_ENDPOINT=
      - ENVIRONMENT=local
      - LOG_LEVEL=debug

  - name: rem-version-info
    behavior: create
    literals:
      - VERSION=local-dev
      - GIT_COMMIT=local
      - BUILD_DATE=local
      - ENVIRONMENT=local

# Patches to simplify production manifests for local use
patches:
  # ============================================================
  # DELETE CRD-dependent and unnecessary resources
  # ============================================================

  # Delete ExternalSecret (requires external-secrets.io CRD)
  - patch: |
      $patch: delete
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: rem-llm-api-keys
    target:
      group: external-secrets.io
      version: v1
      kind: ExternalSecret
      name: rem-llm-api-keys

  # Delete SecretStore (requires external-secrets.io CRD)
  - patch: |
      $patch: delete
      apiVersion: external-secrets.io/v1beta1
      kind: SecretStore
      metadata:
        name: aws-parameter-store
    target:
      group: external-secrets.io
      version: v1beta1
      kind: SecretStore
      name: aws-parameter-store

  # Delete HPA (not needed locally, single replica)
  - patch: |
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: rem-api
    target:
      kind: HorizontalPodAutoscaler
      name: rem-api

  # Delete PodDisruptionBudget (not needed locally)
  - patch: |
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: rem-api
    target:
      kind: PodDisruptionBudget
      name: rem-api

  # Delete NetworkPolicy (not needed locally)
  - patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: rem-api
    target:
      kind: NetworkPolicy
      name: rem-api

  # Delete Ingress (use port-forward locally)
  - patch: |
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: rem-api-alb
    target:
      kind: Ingress
      name: rem-api-alb

  # ============================================================
  # PATCH resources to work locally
  # ============================================================

  # Remove EKS-specific IAM role annotation from ServiceAccount
  - target:
      kind: ServiceAccount
      name: rem-api
    patch: |
      - op: remove
        path: /metadata/annotations

  # Patch deployment for local environment
  - target:
      kind: Deployment
      name: rem-api
    patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      - op: remove
        path: /spec/template/spec/initContainers
      - op: remove
        path: /spec/template/metadata/annotations
      - op: remove
        path: /spec/template/spec/affinity
      - op: remove
        path: /spec/template/spec/containers/0/securityContext
      - op: remove
        path: /spec/template/spec/volumes
      - op: remove
        path: /spec/template/spec/containers/0/volumeMounts

  # Patch deployment container for local env vars and resources
  - target:
      kind: Deployment
      name: rem-api
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: rem-api
      spec:
        template:
          spec:
            containers:
              - name: rem-api
                imagePullPolicy: Never
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "1Gi"
                    cpu: "1000m"
                env:
                  # Override postgres host for local
                  - name: POSTGRES__HOST
                    value: postgres-local.rem-local.svc.cluster.local
                  # Disable auth for local
                  - name: AUTH__ENABLED
                    value: "false"
                  # Disable OTEL for local
                  - name: OTEL__ENABLED
                    value: "false"
                  # Local environment
                  - name: ENVIRONMENT
                    value: local
                  - name: LOG_LEVEL
                    value: debug

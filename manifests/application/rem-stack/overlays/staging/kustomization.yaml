# =============================================================================
# Kustomize Overlay: Staging Environment
# =============================================================================
#
# MVP staging configuration with PUBLIC access.
# Uses percolationlabs/rem:latest from Docker Hub.
#
# Features:
#   - PostgreSQL: 1 replica, 20Gi gp3-postgres (MVP - scale up later)
#   - API: percolationlabs/rem:latest
#   - Phoenix: OTEL collector for observability
#   - Ingress: PUBLIC (internet-facing ALB)
#
# Usage:
#   kubectl apply -k manifests/application/rem-stack/overlays/staging
#
# =============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference base configuration + postgres + phoenix
resources:
  - ../../base
  - ../../components/postgres
  - ../../../phoenix  # Phoenix for OTEL/observability

# Namespace: rem (inherited from base)

# Environment labels (annotations only to avoid selector conflicts)
commonAnnotations:
  environment: staging

# Patches for staging-specific configuration
# Note: percolationlabs/rem:latest is used directly in component manifests
patches:
  - path: postgres-patch.yaml
  - path: ingress-patch.yaml

# ConfigMap generator for staging environment
configMapGenerator:
  - name: rem-version-info
    behavior: merge
    literals:
      - VERSION=latest
      - ENVIRONMENT=staging
      - GIT_COMMIT=${GIT_COMMIT:-unknown}
      - BUILD_DATE=${BUILD_DATE:-unknown}

  # Staging overrides for rem-config (merges with base)
  # Only specify values that differ from base
  - name: rem-config
    behavior: merge
    literals:
      - ENVIRONMENT=staging
      - S3__BUCKET_NAME=rem-application-cluster-app-bucket
      - OTEL_COLLECTOR_ENDPOINT=http://phoenix.rem.svc.cluster.local:4317
      - AUTH__ENABLED=true

# Labels for version tracking (no selectors to avoid immutable field conflicts)
labels:
  - pairs:
      app.kubernetes.io/version: latest
    includeSelectors: false
    includeTemplates: true

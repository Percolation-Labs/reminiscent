# Kustomize Overlay: Production Environment
#
# Production configuration - matches staging for consistency.
# Uses percolationlabs/rem:latest from Docker Hub.
#
# Features:
#   - PostgreSQL: 2 replicas, 100Gi gp3-postgres storage (5000 IOPS)
#   - API: percolationlabs/rem:latest (3 replicas for HA)
#   - High resource allocations
#
# Usage:
#   kubectl apply -k manifests/application/rem-stack/overlays/prod

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Reference base configuration
resources:
  - ../../base
  - ../../components/postgres

# Namespace: rem (inherited from base)

# Environment labels (annotations only to avoid selector conflicts)
commonAnnotations:
  environment: production

# Note: percolationlabs/rem:latest is used directly in component manifests

# ConfigMap generator for production environment
configMapGenerator:
  - name: rem-version-info
    behavior: merge
    literals:
      - VERSION=latest
      - ENVIRONMENT=production
      - GIT_COMMIT=${GIT_COMMIT:-unknown}
      - BUILD_DATE=${BUILD_DATE:-unknown}

  # Production overrides for rem-config (merges with base)
  # Only specify values that differ from base
  - name: rem-config
    behavior: merge
    literals:
      - ENVIRONMENT=production
      - LOG_LEVEL=info
      - S3__BUCKET_NAME=rem-prod-app-bucket
      - OTEL_COLLECTOR_ENDPOINT=http://otel-collector-collector.observability.svc.cluster.local:4318
      - AUTH__ENABLED=true
      - POSTGRES__POOL_MIN_SIZE=10
      - POSTGRES__POOL_MAX_SIZE=50

# Patches for production environment
patches:
  - path: api-patch.yaml
  - path: worker-patch.yaml
  - path: postgres-patch.yaml

# Scale replicas for HA
replicas:
  - name: rem-api
    count: 3

# Labels for version tracking (no selectors to avoid immutable field conflicts)
labels:
  - pairs:
      app.kubernetes.io/version: latest
    includeSelectors: false
    includeTemplates: true

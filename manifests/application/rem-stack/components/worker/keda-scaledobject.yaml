# KEDA ScaledObject for file-processor
#
# Scales deployment based on SQS queue depth
# - Scales up when messages accumulate
# - Scales down to 0 when queue is empty
# - Works with Karpenter for node-level scaling

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: file-processor-scaler
spec:
  # Target deployment to scale
  scaleTargetRef:
    name: file-processor
    kind: Deployment

  # Scaling behavior
  # TODO: KEDA needs Pod Identity for SQS access - currently disabled
  # For now, set minReplicaCount to 1 to avoid scale-to-zero issues with KEDA auth
  pollingInterval: 10   # Check SQS every 10 seconds
  cooldownPeriod: 60    # Wait 60s before scaling down after last trigger
  minReplicaCount: 1    # Keep at least 1 replica (KEDA Pod Identity TBD)
  maxReplicaCount: 20   # Max pods (adjust based on workload)

  # Advanced scaling behavior (optional)
  advanced:
    # Scale up aggressively, scale down gradually
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 5 min stabilization
          policies:
          - type: Percent
            value: 50        # Scale down max 50% of pods at a time
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0   # Scale up immediately
          policies:
          - type: Percent
            value: 100       # Double pods at a time if needed
            periodSeconds: 15
          - type: Pods
            value: 4         # Or add 4 pods at a time
            periodSeconds: 15
          selectPolicy: Max  # Use the policy that adds more pods

  # Triggers (SQS queue)
  # NOTE: KEDA doesn't support ConfigMap refs in trigger metadata
  # Update queueURL from CDK stack output: FileProcessingQueueUrl
  # aws cloudformation describe-stacks --stack-name REMEksClusterB --profile rem \
  #   --query 'Stacks[0].Outputs[?OutputKey==`FileProcessingQueueUrl`].OutputValue' --output text
  triggers:
  - type: aws-sqs-queue
    metadata:
      # SQS Queue URL (from CDK stack output: FileProcessingQueueUrl)
      queueURL: https://sqs.us-east-1.amazonaws.com/852140462228/rem-cluster-b-file-processing-staging
      queueLength: "10"      # Target: 1 pod per 10 messages
      awsRegion: us-east-1
      # Note: KEDA uses default AWS credentials chain (node role via IMDS)
      # For scale-to-zero with Pod Identity, KEDA operator needs separate Pod Identity config

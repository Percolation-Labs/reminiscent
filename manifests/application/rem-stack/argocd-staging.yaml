# ArgoCD Application for REM Stack (Staging)
#
# Deploys the REM stack using Kustomize overlays.
#
# Configuration:
#   Before applying, update the following:
#   1. spec.source.repoURL - Your Git repository
#   2. spec.destination.namespace - Target namespace (default: rem)
#
# Deployment:
#   kubectl apply -f manifests/application/rem-stack/argocd-staging.yaml
#
# Or use the CLI:
#   rem cluster apply --config cluster-config.yaml

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: rem-stack-staging
  namespace: argocd
  labels:
    app.kubernetes.io/name: rem-stack
    environment: staging
spec:
  project: default

  # Source: Git repository with Kustomize
  source:
    # UPDATE THIS: Your Git repository URL
    repoURL: https://github.com/anthropics/remstack.git
    targetRevision: main
    path: manifests/application/rem-stack/overlays/staging

  # Destination: Kubernetes cluster and namespace
  destination:
    server: https://kubernetes.default.svc
    # UPDATE THIS: Target namespace (should match cluster-config.yaml project.namespace)
    namespace: rem

  # Ignore differences for operator-managed fields
  # These are fields that operators add as defaults or manage themselves
  ignoreDifferences:
    # External Secrets Operator adds default values to ExternalSecret specs
    - group: external-secrets.io
      kind: ExternalSecret
      jqPathExpressions:
        - .spec.data[].remoteRef.conversionStrategy
        - .spec.data[].remoteRef.metadataPolicy
        - .spec.data[].remoteRef.decodingStrategy
        - .spec.target.deletionPolicy
        - .spec.target.template.mergePolicy
        - .spec.target.template.metadata

    # CloudNativePG adds many default fields to Cluster spec
    - group: postgresql.cnpg.io
      kind: Cluster
      jsonPointers:
        - /spec

    # HPA/KEDA manages deployment replicas
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas

    # KEDA manages trigger configuration
    - group: keda.sh
      kind: ScaledObject
      jsonPointers:
        - /spec/triggers

  # Sync policy
  syncPolicy:
    automated:
      prune: true       # Delete resources removed from git
      selfHeal: true    # Sync when cluster state differs from git
      allowEmpty: false # Don't sync if source is empty

    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      # CRITICAL: Must be enabled for ignoreDifferences to work
      - RespectIgnoreDifferences=true

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  revisionHistoryLimit: 10

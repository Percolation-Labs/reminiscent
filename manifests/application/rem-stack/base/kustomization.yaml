# Kustomize Base for REM Stack
#
# This is the base configuration containing all components:
# - REM API (FastAPI + MCP server at /api/v1/mcp)
# - File Processor (KEDA-scaled worker)
# - Dreaming Worker (CronJob for background processing)
# - PostgreSQL (CloudNativePG) - optional, deploy separately
#
# This base is environment-agnostic. Use overlays for environment-specific config.
#
# Usage:
#   kubectl apply -k manifests/application/rem-stack/base
#   kubectl apply -k manifests/application/rem-stack/overlays/staging
#   kubectl apply -k manifests/application/rem-stack/overlays/prod

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Single namespace for all application components
namespace: rem

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: rem-stack
  app.kubernetes.io/managed-by: kustomize

# Common annotations
commonAnnotations:
  kustomize.toolkit.fluxcd.io/prune: "Enabled"

# Components (each has its own kustomization.yaml)
resources:
  - ../components/api
  - ../components/worker
  # NOTE: dreaming-worker disabled for MVP - needs fixes:
  #   - Hardcoded namespace (needs alignment with kustomize namespace)
  #   - IRSA placeholder ${REM_WORKER_ROLE_ARN} needs Pod Identity
  #   - Secret references need alignment
  # - ../components/dreaming-worker
  # Postgres is separate - deploy to its own namespace
  # kubectl apply -k ../components/postgres --namespace postgres

# Note: percolationlabs/rem:latest is used directly in component manifests

# Generate ConfigMaps
configMapGenerator:
  - name: rem-version-info
    literals:
      - VERSION=unset
      - GIT_COMMIT=unset
      - BUILD_DATE=unset
      - ENVIRONMENT=base

  # ==========================================================================
  # rem-config: Single source of truth for application configuration
  # ==========================================================================
  # Override values in environment overlays (staging, prod) using behavior: merge
  #
  # Categories:
  #   - Environment: ENVIRONMENT, LOG_LEVEL
  #   - AWS: AWS_REGION, S3__BUCKET_NAME, S3__REGION
  #   - Database: POSTGRES__POOL_MIN_SIZE, POSTGRES__POOL_MAX_SIZE
  #   - Observability: OTEL__ENABLED, OTEL_COLLECTOR_ENDPOINT, OTEL_SERVICE_NAME
  #   - LLM: LLM__DEFAULT_MODEL
  #   - Auth: AUTH__ENABLED
  #   - Custom Models: MODELS__IMPORT_MODULES
  #
  # Secrets (API keys, passwords) are NOT in ConfigMap - use ExternalSecrets
  # ==========================================================================
  - name: rem-config
    literals:
      # Environment
      - ENVIRONMENT=base
      - LOG_LEVEL=info
      # AWS
      - AWS_REGION=us-east-1
      - S3__BUCKET_NAME=unset
      - S3__REGION=us-east-1
      # Database pool settings (connection string is built from secrets in deployment)
      - POSTGRES__POOL_MIN_SIZE=5
      - POSTGRES__POOL_MAX_SIZE=20
      # Observability - override OTEL_COLLECTOR_ENDPOINT in overlays
      - OTEL__ENABLED=true
      - OTEL_COLLECTOR_ENDPOINT=http://localhost:4318
      - OTEL_SERVICE_NAME=rem-api
      # LLM defaults
      - LLM__DEFAULT_MODEL=openai:gpt-4.1
      # Auth
      - AUTH__ENABLED=false
      # Custom models (for downstream apps)
      - MODELS__IMPORT_MODULES=models

# Generate labels for version tracking
labels:
  - pairs:
      app.kubernetes.io/version: unset
    includeSelectors: true
    includeTemplates: true

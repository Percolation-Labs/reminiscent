# Kustomize Base for REM Stack
#
# This is the base configuration containing all components:
# - REM API (FastAPI + MCP server at /api/v1/mcp)
# - File Processor (KEDA-scaled worker)
# - Dreaming Worker (CronJob for background processing)
# - PostgreSQL (CloudNativePG) - optional, deploy separately
#
# This base is environment-agnostic. Use overlays for environment-specific config.
#
# Usage:
#   kubectl apply -k manifests/application/rem-stack/base
#   kubectl apply -k manifests/application/rem-stack/overlays/staging
#   kubectl apply -k manifests/application/rem-stack/overlays/prod

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Single namespace for all application components
namespace: siggy

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: rem-stack
  app.kubernetes.io/managed-by: kustomize

# Common annotations
commonAnnotations:
  kustomize.toolkit.fluxcd.io/prune: "Enabled"

# Components (each has its own kustomization.yaml)
resources:
  - ../components/api
  - ../components/worker
  # NOTE: dreaming-worker disabled for MVP - needs fixes:
  #   - Hardcoded namespace (rem-app vs siggy)
  #   - IRSA placeholder ${REM_WORKER_ROLE_ARN} needs Pod Identity
  #   - Secret references need alignment
  # - ../components/dreaming-worker
  # Postgres is separate - deploy to its own namespace
  # kubectl apply -k ../components/postgres --namespace postgres

# Note: percolationlabs/rem:latest is used directly in component manifests

# Generate ConfigMaps
configMapGenerator:
  - name: rem-version-info
    literals:
      - VERSION=unset
      - GIT_COMMIT=unset
      - BUILD_DATE=unset
      - ENVIRONMENT=base

  # Application config - required by deployments
  # Override in environment overlays (staging, prod)
  - name: rem-config
    literals:
      - ENVIRONMENT=base
      - AWS_REGION=us-east-1
      - S3__BUCKET_NAME=unset  # Override in overlay
      - OTEL_COLLECTOR_ENDPOINT=http://localhost:4317

# Generate labels for version tracking
labels:
  - pairs:
      app.kubernetes.io/version: unset
    includeSelectors: true
    includeTemplates: true

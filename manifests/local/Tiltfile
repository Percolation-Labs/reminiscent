# -*- mode: python -*-
# Tiltfile for REM Stack Local Development
#
# Usage:
#   tilt up                        # Start with docker-compose (default)
#   tilt up -- --enable_minio      # + MinIO for S3 testing
#   tilt up -- --k8s_mode          # Local Kubernetes mode
#
# Dashboard: http://localhost:10350
#
# This Tiltfile manages:
# - PostgreSQL database (pgvector)
# - Backend API (REM-based)
# - Worker (file processor)
# - Database migrations
# - Development tasks

# =============================================================================
# Configuration
# =============================================================================

config.define_bool("enable_minio", False, "Enable MinIO for S3 testing")
config.define_bool("k8s_mode", False, "Use local Kubernetes instead of docker-compose")
cfg = config.parse()

enable_minio = cfg.get("enable_minio", False)
k8s_mode = cfg.get("k8s_mode", False)

# =============================================================================
# TIER 3: Local Kubernetes Mode
# =============================================================================

if k8s_mode:
    print("Running in Kubernetes mode (requires kind/minikube)")

    # Build REM image and load into local cluster
    docker_build(
        'rem-local',
        context='../../rem',
        dockerfile='../../rem/Dockerfile',
        live_update=[
            sync('../../rem/src', '/app/src'),
        ]
    )

    # Apply local Kustomize overlay (uses production manifests as base)
    # Path: manifests/application/rem-stack/overlays/local
    k8s_yaml(kustomize('../application/rem-stack/overlays/local'))

    # Configure K8s resources
    k8s_resource('postgres-local',
        port_forwards=['5432:5432'],
        labels=['database'],
    )

    k8s_resource('rem-api',
        port_forwards=['8000:8000'],
        resource_deps=['postgres-local'],
        labels=['app'],
        links=[
            link('http://localhost:8000', 'API'),
            link('http://localhost:8000/docs', 'Swagger UI'),
        ],
    )

    # Note: file-processor not included in local overlay (uses KEDA CRDs)
    # Use docker-compose mode (Tier 1) if you need the worker

# =============================================================================
# TIER 1 & 2: Docker Compose Mode
# =============================================================================

else:
    print("Running in Docker Compose mode")

    compose_files = ['../../rem/docker-compose.yml']
    if enable_minio:
        compose_files.append('./docker-compose.minio.yml')
        print("   + MinIO enabled for S3 testing")

    docker_compose(compose_files)

    # Configure resources with UI enhancements
    dc_resource('postgres',
        labels=['database'],
    )

    dc_resource('api',
        labels=['app'],
        resource_deps=['postgres'],
        links=[
            link('http://localhost:8000', 'API'),
            link('http://localhost:8000/docs', 'Swagger UI'),
            link('http://localhost:8000/health', 'Health Check'),
        ],
    )

    dc_resource('worker',
        labels=['app'],
        resource_deps=['postgres'],
    )

    if enable_minio:
        dc_resource('minio',
            labels=['storage'],
            links=[
                link('http://localhost:9001', 'MinIO Console'),
            ],
        )

# =============================================================================
# Developer Task Buttons
# =============================================================================

# Database migrations - runs REM's migration system
local_resource(
    'db-migrate',
    cmd='cd ../../rem && uv run rem db migrate',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Show migration status
local_resource(
    'db-status',
    cmd='cd ../../rem && uv run rem db status',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Health check
local_resource(
    'health-check',
    cmd='curl -sf http://localhost:8000/health | python3 -m json.tool || echo "API not ready"',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Reset database (destructive!)
local_resource(
    'db-reset',
    cmd='docker compose -f ../../rem/docker-compose.yml down -v postgres && docker compose -f ../../rem/docker-compose.yml up -d postgres',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Test REM queries against database
local_resource(
    'test-rem-query',
    cmd='''cd ../../rem && uv run python -c "
import asyncio
from rem.services.postgres import get_postgres_service

async def test():
    pg = get_postgres_service()
    if pg is None:
        print('ERROR: PostgresService not available')
        return
    await pg.connect()
    result = await pg.execute('SELECT version()')
    print('Database connection: OK')
    print(f'PostgreSQL: {result[0][\"version\"][:60]}...')
    await pg.disconnect()

asyncio.run(test())
"''',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Run integration tests
local_resource(
    'test-integration',
    cmd='cd ../../rem && uv run pytest tests/integration/ -v -m "not llm" --tb=short',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Run unit tests
local_resource(
    'test-unit',
    cmd='cd ../../rem && uv run pytest tests/unit/ -v --tb=short',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

# Type check
local_resource(
    'type-check',
    cmd='cd ../../rem && ./scripts/run_mypy.sh',
    labels=['tasks'],
    auto_init=False,
    trigger_mode=TRIGGER_MODE_MANUAL,
)

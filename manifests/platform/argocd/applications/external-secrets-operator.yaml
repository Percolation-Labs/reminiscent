# External Secrets Operator - ArgoCD Application
#
# Installs ESO to sync secrets from AWS SSM/Secrets Manager to Kubernetes.
# Uses HTTPS chart (not OCI) for reliability.
#
# Pod Identity:
#   CDK creates Pod Identity association for 'external-secrets' service account
#   in 'external-secrets-system' namespace.
#
# IMPORTANT: Namespace MUST be 'external-secrets-system' to match CDK Pod Identity

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-secrets-operator
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default

  source:
    # Use HTTPS chart repo (more reliable than OCI)
    repoURL: https://charts.external-secrets.io
    chart: external-secrets
    targetRevision: "0.20.4"  # Stable version, tested with Pod Identity

    helm:
      valuesObject:
        # Install CRDs with the chart
        installCRDs: true

        # Webhook configuration
        webhook:
          create: true
        certController:
          create: true

        # Service account - must match CDK Pod Identity configuration
        serviceAccount:
          create: true
          name: external-secrets
          # No annotations needed - Pod Identity handles auth automatically

  destination:
    server: https://kubernetes.default.svc
    # CRITICAL: Must match CDK Pod Identity namespace
    namespace: external-secrets-system

  # Ignore webhook CA bundle differences (auto-generated)
  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - RespectIgnoreDifferences=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
